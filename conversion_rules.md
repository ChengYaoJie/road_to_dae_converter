# OpenDRIVE/OSM到DAE转换技术文档

## 1. 格式分析

### 1.1 OpenDRIVE格式结构

OpenDRIVE是一种用于描述道路网络的XML格式，主要包含以下关键元素：

- **道路几何信息**：在`<road>`和`<planView>`中定义
  - 直线路段用`<line>`元素表示
  - 包含起点坐标(x, y)、航向角(hdg)和长度(length)

- **车道信息**：在`<lanes>`中定义
  - 分为左侧(left)、中央(center)和右侧(right)车道
  - 每个车道有ID、类型(type)和宽度(width)
  - 支持多种车道类型：driving(行车道)、shoulder(路肩)等

- **道路标记**：在`<roadMark>`中定义
  - 包含类型(type)、宽度(width)、颜色(color)和材质(material)
  - 标记类型有solid(实线)、broken(虚线)、solid solid(双实线)等

- **对象**：在`<objects>`中定义额外的道路元素
  - 如道路标志、标记等

### 1.2 COLLADA/DAE格式结构

COLLADA是一种用于交换3D资产的XML格式，主要包含以下关键元素：

- **材质和效果**：在`<library_effects>`和`<library_materials>`中定义
  - 定义表面的视觉属性如漫反射、发射光等

- **纹理图像**：在`<library_images>`中定义
  - 引用外部图像文件作为纹理

- **几何网格**：在`<library_geometries>`中定义
  - 包含顶点位置(vertices)
  - 包含法线方向(normals)
  - 包含纹理坐标(texcoords)
  - 包含面定义(faces)，指定哪些顶点组成多边形

- **场景结构**：在`<library_visual_scenes>`中定义
  - 实例化几何体
  - 定义变换矩阵

## 2. 映射规则

### 2.1 几何映射

- **道路中心线** → **3D模型基线**
  - OpenDRIVE中的道路几何信息(planView)转换为3D模型的基线
  - 直线路段保持为直线
  - 高度默认设置为0（可以根据elevationProfile调整）

- **车道宽度** → **多边形宽度**
  - 每个车道的宽度信息用于计算多边形的横向扩展
  - 左右车道分别向中心线两侧扩展

- **车道连接** → **多边形连接**
  - 相邻车道的边缘顶点连接形成连续的道路表面

### 2.2 材质映射

- **道路表面类型** → **材质**
  - 沥青路面(asphalt)映射到具有Asphalt纹理的材质
  - 路肩(shoulder)映射到相应材质

- **道路标记类型** → **材质**
  - 白色实线/虚线映射到LaneMarking1材质
  - 黄色实线/虚线映射到LaneMarkingYellow1材质

### 2.3 纹理映射

- **道路延伸方向** → **纹理S轴**
  - 道路长度方向映射到纹理的S轴

- **道路宽度方向** → **纹理T轴**
  - 道路宽度方向映射到纹理的T轴

- **纹理坐标计算**
  - S坐标：沿道路长度的归一化位置
  - T坐标：沿道路宽度的归一化位置

## 3. 转换流程

### 3.1 预处理

1. 解析OpenDRIVE/OSM文件
2. 提取道路几何数据
3. 提取车道信息和道路标记

### 3.2 几何生成

1. 计算道路中心线的3D坐标
2. 基于车道宽度生成每个车道的多边形
3. 合并多边形生成完整的道路表面
4. 为道路标记生成单独的多边形

### 3.3 材质和纹理处理

1. 创建道路表面材质
2. 创建道路标记材质
3. 生成纹理坐标

### 3.4 DAE文件生成

1. 创建COLLADA XML结构
2. 添加材质、效果和图像引用
3. 添加几何体定义（顶点、法线、纹理坐标和面）
4. 创建视觉场景并实例化几何体
5. 保存为DAE文件

## 4. 特殊情况处理

### 4.1 弯道处理
- 对于弯道部分，需要使用曲线插值计算顶点位置

### 4.2 道路标记
- 虚线需要根据间距生成间断的线段
- 双实线需要生成两条平行线段

### 4.3 高程变化
- 根据OpenDRIVE的elevationProfile调整道路Z坐标

## 5. 坐标系统

- OpenDRIVE通常使用右手坐标系，X东Y北
- COLLADA使用Z轴向上的坐标系
- 需要进行坐标变换确保正确的方向